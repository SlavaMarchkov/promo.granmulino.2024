import{o as i,l as S,w as r,f as t,t as n,g as a,j as l,i as m,T as q,r as j,e as J,a1 as Q,d as h,H as U,c as p,F as B,h as k,m as F,p as u,s as R,I as A,q as _}from"./app-CcRn7-yu.js";import{u as W}from"./useHttpService-F7Gi0evP.js";import{f as g,p as E}from"./formatters-hPmLyB9N.js";import{_ as X,u as Z}from"./TheModal-BP7wSSzT.js";import{_ as v,a as ee}from"./TwoColumnRow-DboPzJPi.js";const te={class:"mb-0"},se={class:"mb-0 fw-bold text-primary"},oe=t("hr",null,null,-1),de={__name:"DiscountProductCard",props:{index:{type:Number,default:1},product:{type:Object,required:!0}},emits:["removeProduct"],setup(y,{emit:x}){const c=y,I=x,w=()=>{I("removeProduct",c.index)};return(P,V)=>(i(),S(ee,{"header-classes":["bg-secondary-subtle py-2 fw-bold text-black"],"with-footer":""},{header:r(()=>[t("h5",te,n(c.product.categoryName),1)]),body:r(()=>[t("h6",se,n(c.product.productName),1),oe,a(v,{title:"Продажи"},{default:r(()=>[l(n(m(g)(c.product.salesBefore))+" шт.",1)]),_:1}),a(v,{title:"План"},{default:r(()=>[l(n(m(g)(c.product.salesPlan))+" шт.",1)]),_:1}),a(v,{cols:"7",title:"Прирост"},{default:r(()=>[l(n(m(g)(c.product.surplusPlan))+" %",1)]),_:1}),a(v,{title:"Бюджет"},{default:r(()=>[l(n(m(g)(c.product.budgetPlan))+" руб.",1)]),_:1})]),footer:r(()=>[a(q,{class:"btn-danger w-100",onClick:w},{default:r(()=>[l("Удалить ")]),_:1})]),_:1}))}},ae={class:"card"},re={class:"card-header bg-success text-white"},le={class:"card-body mt-3"},ne={class:"d-flex justify-content-between align-items-center"},ie=t("h4",{class:"mb-0"},"Итоговый бюджет на промо-акцию:",-1),ce={class:"text-primary fw-bold mb-0"},ue=t("hr",null,null,-1),pe={class:"row"},me={class:"col-6"},_e={class:"mb-0 alert border-primary fade show",role:"alert"},fe={class:"mb-0"},ge={class:"fw-bold text-primary"},Pe={class:"col-6"},be={class:"mb-0 alert border-primary fade show",role:"alert"},he={class:"mb-0"},ve={class:"fw-bold text-primary"},ye=t("hr",null,null,-1),xe={class:"d-flex justify-content-between align-items-center"},Ie=t("span",null,"Ассортимент для промо-акции",-1),we=t("hr",null,null,-1),Ve={key:0,class:"row row-cols-xl-3 row-cols-lg-3 row-cols-md-2 row-cols-sm-2 row-cols-1 g-3"},Ne={class:"row g-3"},Ue={class:"col-md-6"},Be=t("option",{disabled:"",selected:"",value:""},"-- Выберите группу товара --",-1),ke=["value"],Se={class:"col-md-6"},qe=t("option",{disabled:"",selected:"",value:""},"-- Выберите SKU для промо-акции --",-1),Ce=["value"],Me={class:"col-md-4"},$e={class:"input-group"},Te=t("span",{class:"input-group-text"},"шт.",-1),De=t("div",{id:"sales_before_help",class:"form-text"},"если продаж не было, введите 0",-1),je={class:"col-md-4"},Fe={class:"input-group"},Re=t("span",{class:"input-group-text"},"шт.",-1),Ae={class:"col-md-4"},Ee={class:"input-group"},Le=t("span",{class:"input-group-text"},"%",-1),Oe=t("div",{id:"surplus_plan_help",class:"form-text"},"рассчитывается автоматически",-1),Ge={class:"col-md-4"},He={class:"input-group"},Ke=t("span",{class:"input-group-text"},"руб.",-1),Ye=t("div",{id:"profit_per_unit_help",class:"form-text"},"берётся из P&L",-1),ze={class:"col-md-4"},Je={class:"input-group"},Qe=t("span",{class:"input-group-text"},"руб.",-1),We=t("div",{id:"compensation_help",class:"form-text"},"если компенсации нет, введите 0",-1),Xe={class:"col-md-4"},Ze={class:"input-group"},et=t("span",{class:"input-group-text"},"руб.",-1),tt=t("div",{id:"budget_plan_help",class:"form-text"},"компенсация * план продаж",-1),lt={__name:"TheDiscount",props:{title:{type:String,required:!0,default:"Title is required"},customerName:{type:String,default:""},retailerName:{type:String,default:""}},emits:["addProductsToPromo"],setup(y,{emit:x}){const{get:c}=W(),{calcDifferencePercentage:I,calcBudget:w}=Z(),P=y,V=x,C=()=>({categoryId:"",productId:"",salesBefore:"",salesPlan:"",surplusPlan:0,profitPerUnit:"",compensation:"",budgetPlan:0}),e=j({categories:[],products:[],addedProducts:[],addedProductsIds:[],form:C()}),f=j({addModalPopUp:!1});J(async()=>{await L()});const L=async()=>{const{data:d}=await c(Q.CATEGORY,{params:{category_is_active:!0,product_is_active:!0,products:!0}});e.categories=d.categories},O=()=>{e.categories.map(d=>{+d.id==+e.form.categoryId&&(e.products=d.products)}),e.products=e.products.filter(d=>!e.addedProductsIds.includes(d.id))},G=()=>{e.addedProducts.push({categoryId:e.form.categoryId,productId:e.form.productId,categoryName:K(),productName:Y(),salesBefore:e.form.salesBefore,salesPlan:e.form.salesPlan,surplusPlan:e.form.surplusPlan,budgetPlan:e.form.budgetPlan,compensation:e.form.compensation,profitPerUnit:e.form.profitPerUnit}),e.addedProductsIds.push(+e.form.productId),V("addProductsToPromo",e.addedProducts,M.value,$.value,b.value),e.products=[],f.addModalPopUp=!1},H=d=>{e.addedProducts.splice(d,1),e.addedProductsIds.splice(d,1),V("addProductsToPromo",e.addedProducts,M.value,$.value,b.value)},K=()=>{const d=e.categories.findIndex(o=>+o.id==+e.form.categoryId);return e.categories[d].name},Y=()=>{const d=e.categories.findIndex(s=>+s.id==+e.form.categoryId),o=e.categories[d].products.findIndex(s=>s.id===+e.form.productId);return e.categories[d].products[o].name},z=h(()=>{let d=!0;const o=["salesBefore","surplusPlan","compensation","budgetPlan"];for(let[s,N]of Object.entries(e.form))if(!o.includes(s)&&!N){d=!1;break}return d}),M=h(()=>e.addedProducts.reduce((d,o)=>d+parseInt(o.salesBefore),0)),$=h(()=>e.addedProducts.reduce((d,o)=>d+parseInt(o.salesPlan),0)),b=h(()=>e.addedProducts.reduce((d,o)=>d+parseInt(o.budgetPlan),0));U(()=>e.form.salesBefore,()=>T()),U(()=>e.form.salesPlan,()=>{T(),D()}),U(()=>e.form.compensation,()=>{D()});function T(){const d=I(e.form.salesBefore.toString(),e.form.salesPlan.toString());e.form.surplusPlan=isNaN(d)?0:d}function D(){const d=w(e.form.salesPlan,e.form.compensation);e.form.budgetPlan=isNaN(d)?0:d}return(d,o)=>(i(),p("div",null,[t("div",ae,[t("div",re,n(P.title),1),t("div",le,[t("div",ne,[ie,t("h4",ce,n(isNaN(b.value)?"0":m(g)(b.value))+" руб.",1)]),ue,t("div",pe,[t("div",me,[t("div",_e,[t("h5",fe,[l("Дистрибутор: "),t("span",ge,n(P.customerName),1)])])]),t("div",Pe,[t("div",be,[t("h5",he,[l("Сеть: "),t("span",ve,n(P.retailerName),1)])])])]),ye,t("div",xe,[Ie,a(q,{onClick:o[0]||(o[0]=s=>{f.addModalPopUp=!0,e.form=C(),e.products=[]}),class:"btn-success"},{default:r(()=>[l("Добавить")]),_:1})]),we,e.addedProducts.length>0?(i(),p("div",Ve,[(i(!0),p(B,null,k(e.addedProducts,(s,N)=>(i(),S(de,{key:s.id,index:N,product:s,onRemoveProduct:H},null,8,["index","product"]))),128))])):F("",!0)])]),f.addModalPopUp?(i(),S(X,{key:0,modelValue:f.addModalPopUp,"onUpdate:modelValue":o[11]||(o[11]=s=>f.addModalPopUp=s),id:"addModalPopUp","custom-classes":["modal-lg"]},{title:r(()=>[l(" Добавление ассортимента для промо-акции ")]),body:r(()=>[t("div",Ne,[t("div",Ue,[a(u,{for:"category_id",required:""},{default:r(()=>[l("Группа товара")]),_:1}),R(t("select",{"onUpdate:modelValue":o[1]||(o[1]=s=>e.form.categoryId=s),onChange:O,id:"category_id",class:"form-select"},[Be,(i(!0),p(B,null,k(e.categories,s=>(i(),p("option",{key:s.id,value:s.id},n(s.name),9,ke))),128))],544),[[A,e.form.categoryId]])]),t("div",Se,[a(u,{for:"product_id",required:""},{default:r(()=>[l("Ассортимент")]),_:1}),R(t("select",{"onUpdate:modelValue":o[2]||(o[2]=s=>e.form.productId=s),id:"product_id",class:"form-select"},[qe,(i(!0),p(B,null,k(e.products,s=>(i(),p("option",{key:s.id,value:s.id},n(s.name),9,Ce))),128))],512),[[A,e.form.productId]])]),t("div",Me,[a(u,{for:"sales_before",required:""},{default:r(()=>[l('Продажи "До акции"')]),_:1}),t("div",$e,[a(_,{id:"sales_before",modelValue:e.form.salesBefore,"onUpdate:modelValue":o[3]||(o[3]=s=>e.form.salesBefore=s),type:"text",class:"text-end","aria-describedby":"sales_before_help",onBlur:o[4]||(o[4]=s=>m(E)(s.target.value,"sales_before"))},null,8,["modelValue"]),Te]),De]),t("div",je,[a(u,{for:"sales_plan",required:""},{default:r(()=>[l('План продаж "Во время"')]),_:1}),t("div",Fe,[a(_,{id:"sales_plan",modelValue:e.form.salesPlan,"onUpdate:modelValue":o[5]||(o[5]=s=>e.form.salesPlan=s),type:"text",class:"text-end",onBlur:o[6]||(o[6]=s=>m(E)(s.target.value,"sales_plan"))},null,8,["modelValue"]),Re])]),t("div",Ae,[a(u,{for:"surplus_plan",required:""},{default:r(()=>[l("План прироста")]),_:1}),t("div",Ee,[a(_,{id:"surplus_plan",modelValue:e.form.surplusPlan,"onUpdate:modelValue":o[7]||(o[7]=s=>e.form.surplusPlan=s),type:"text",class:"text-end fw-bold",disabled:"disabled","aria-describedby":"surplus_plan_help"},null,8,["modelValue"]),Le]),Oe]),t("div",Ge,[a(u,{for:"profit_per_unit",required:""},{default:r(()=>[l("Прибыль на 1 шт.")]),_:1}),t("div",He,[a(_,{id:"profit_per_unit",modelValue:e.form.profitPerUnit,"onUpdate:modelValue":o[8]||(o[8]=s=>e.form.profitPerUnit=s),type:"number",min:"0",step:"0.01","aria-describedby":"profit_per_unit_help"},null,8,["modelValue"]),Ke]),Ye]),t("div",ze,[a(u,{for:"compensation",required:""},{default:r(()=>[l("Компенсация на 1 шт.")]),_:1}),t("div",Je,[a(_,{id:"compensation",modelValue:e.form.compensation,"onUpdate:modelValue":o[9]||(o[9]=s=>e.form.compensation=s),type:"number",min:"0",step:"0.01","aria-describedby":"compensation_help"},null,8,["modelValue"]),Qe]),We]),t("div",Xe,[a(u,{for:"budget_plan",required:""},{default:r(()=>[l("Бюджет")]),_:1}),t("div",Ze,[a(_,{id:"budget_plan",modelValue:e.form.budgetPlan,"onUpdate:modelValue":o[10]||(o[10]=s=>e.form.budgetPlan=s),class:"text-end fw-bold",type:"text",disabled:"disabled","aria-describedby":"budget_plan_help"},null,8,["modelValue"]),et]),tt])])]),footer:r(()=>[a(q,{onClick:G,class:"btn-success w-25",disabled:!z.value},{default:r(()=>[l("Добавить")]),_:1},8,["disabled"])]),_:1},8,["modelValue"])):F("",!0)]))}};export{lt as default};
