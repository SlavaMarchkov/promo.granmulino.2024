import{o as m,c as p,f as t,g as f,x as T,q as y,i as B,ae as V,w as j,T as D,af as C,r as L,d as P,ag as O,t as I,F as S,h as F,l as R,m as U,H,a1 as M,k as Q,j as x,P as z}from"./app-BPdZrYo3.js";import{u as G}from"./useHttpService-BNZ4gPHT.js";import{u as W}from"./useArrayHandlers-D3DGTb70.js";import{c as w,f as $,b as A}from"./formatters-hPmLyB9N.js";const J={class:"list-group-item m-0 px-2"},K={class:"row g-2"},X={class:"col-md-5 col-sm-12"},Y={class:"col-md-2 col-sm-6"},Z={class:"col-md-2 col-sm-6"},ee={class:"col-md-2 col-sm-6"},se={class:"col-md-1 col-sm-6 text-center"},le=t("i",{class:"bi-x-lg"},null,-1),q={__name:"SalesPeopleSellerItem",props:{seller:{type:Object,required:!0},index:{type:Number,default:1}},emits:["addSeller"],setup(v,{emit:E}){const i=v,b=E,_=(o,s)=>{let l=i.seller;const u=document.getElementById(`${s}_salesBefore`),a=document.getElementById(`${s}_surplusPlan`),e=document.getElementById(`${s}_salesPlan`);let r=w(o.target.value),n,c,h;isNaN(r)?(n=0,c=0,h=0,u.value="",a.value="",e.value="",a.setAttribute("readonly","readonly"),e.setAttribute("readonly","readonly")):r===0?(r=0,n=0,c=0,h=0,a.value=n,e.value=c,a.setAttribute("readonly","readonly"),e.removeAttribute("readonly")):(n=a.value===""?V:w(a.value),c=+(r+r*n/100).toFixed(2),h=g(c),u.value=$(r),e.value=A(c),e.setAttribute("readonly","readonly"),a.removeAttribute("readonly"),a.value=n),l.sellerId=l.id,l.salesBefore=r,l.surplusPlan=n,l.salesPlan=c,l.budgetPlan=h,b("addSeller",l)},N=(o,s)=>{let l=i.seller;const u=document.getElementById(`${s}_salesBefore`),a=document.getElementById(`${s}_surplusPlan`),e=document.getElementById(`${s}_salesPlan`);let r=w(u.value),n=w(o.target.value),c,h;isNaN(n)&&(n=0,a.value=n),c=+(r+r*n/100).toFixed(2),h=g(c),a.value=$(n),e.value=A(c),l.sellerId=l.id,l.salesBefore=r,l.surplusPlan=n,l.salesPlan=c,l.budgetPlan=h,b("addSeller",l)},d=(o,s)=>{let l=i.seller;const u=document.getElementById(`${s}_salesPlan`);let a=w(o.target.value),e=0,r=0,n;isNaN(a)?(a=0,u.value=a):(n=g(a),a=+a.toFixed(2),u.value=$(a)),l.salesBefore=e,l.surplusPlan=r,l.salesPlan=a,l.budgetPlan=n,b("addSeller",l)},g=o=>+(o*C/100).toFixed(2),k=o=>{let s=i.seller;const l=document.getElementById(`${o}_salesBefore`),u=document.getElementById(`${o}_surplusPlan`),a=document.getElementById(`${o}_salesPlan`);l.value="",u.value="",a.value="",u.setAttribute("readonly","readonly"),a.setAttribute("readonly","readonly"),s.salesBefore=0,s.surplusPlan=0,s.salesPlan=0,s.budgetPlan=0,b("addSeller",s)};return(o,s)=>(m(),p("li",J,[t("div",K,[t("div",X,[f(y,{value:i.seller.shortName,class:T({"border-danger":!i.seller.supervisorId}),readonly:""},null,8,["value","class"])]),t("div",Y,[f(y,{id:`${v.index}_salesBefore`,class:T(["text-end",{"border-danger":!i.seller.supervisorId}]),onInput:s[0]||(s[0]=l=>_(l,v.index))},null,8,["id","class"])]),t("div",Z,[f(y,{id:`${v.index}_surplusPlan`,class:T(["text-end",{"border-danger":!i.seller.supervisorId}]),"model-value":B(V),onInput:s[1]||(s[1]=l=>N(l,v.index)),maxlength:"3",readonly:"readonly"},null,8,["id","class","model-value"])]),t("div",ee,[f(y,{id:`${v.index}_salesPlan`,class:T(["text-end",{"border-danger":!i.seller.supervisorId}]),onInput:s[2]||(s[2]=l=>d(l,v.index)),readonly:"readonly"},null,8,["id","class"])]),t("div",se,[f(D,{class:"btn-outline-danger",onClick:s[3]||(s[3]=l=>k(v.index))},{default:j(()=>[le]),_:1})])])]))}},te={class:"list-group-item m-0 px-2"},ae={class:"row g-2"},re={class:"col-md-5 col-sm-12"},oe={class:"input-group"},ne={class:"input-group-text"},de=["value"],ie={class:"col-md-2 col-sm-6"},ce={class:"col-md-2 col-sm-6"},ue={class:"col-md-2 col-sm-6"},me=t("div",{class:"col-md-1 col-sm-6 text-center"},null,-1),ve={__name:"SalesPeopleSupervisorItem",props:{supervisor:{type:Object,required:!0},index:{type:Number,default:1},sellers:{type:Array,required:!0,default:()=>[]}},emits:["addToCheckedSellers"],setup(v,{emit:E}){const i=v,b=E,_=L({sellers:[]}),N=o=>{b("addToCheckedSellers",o);let s=i.supervisor;const l=_.sellers.findIndex(e=>e.id===o.id);l===-1?_.sellers.push(o):_.sellers[l]={...o};const u=document.getElementById(`${i.supervisor.id}_SV_salesBefore`),a=document.getElementById(`${i.supervisor.id}_SV_salesPlan`);u.value=d.value===0?"":$(d.value),a.value=g.value===0?"":A(g.value),s.sellerId=s.id,s.salesBefore=d,s.salesPlan=g,s.budgetPlan=k,b("addToCheckedSellers",s)},d=P(()=>_.sellers.reduce((o,s)=>(isNaN(s.salesBefore)&&(s.salesBefore=0),o+s.salesBefore),0)),g=P(()=>_.sellers.reduce((o,s)=>o+s.salesPlan,0)),k=P(()=>+(g.value*O/100).toFixed(2));return(o,s)=>(m(),p(S,null,[t("li",te,[t("div",ae,[t("div",re,[t("div",oe,[t("span",ne,I(v.index+1),1),t("input",{value:i.supervisor.shortName,class:"form-control fw-bold",readonly:"",type:"text"},null,8,de)])]),t("div",ie,[f(y,{id:`${i.supervisor.id}_SV_salesBefore`,class:"fw-bold border-primary text-end",type:"text",readonly:""},null,8,["id"])]),t("div",ce,[f(y,{disabled:"disabled"})]),t("div",ue,[f(y,{id:`${i.supervisor.id}_SV_salesPlan`,class:"fw-bold border-success text-end",type:"text",readonly:""},null,8,["id"])]),me])]),(m(!0),p(S,null,F(i.sellers,(l,u)=>(m(),p(S,{key:l.id},[l.supervisorId===i.supervisor.id?(m(),R(q,{key:0,seller:l,index:u,onAddSeller:N},null,8,["seller","index"])):U("",!0)],64))),128))],64))}},_e={class:"card"},pe={class:"card-header bg-secondary text-white"},fe={class:"card-body mt-3"},he={class:"d-flex justify-content-between align-items-center"},ge=t("h4",{class:"mb-0"},"Планируемый бюджет на промо-акцию:",-1),ye={class:"text-primary fw-bold mb-0"},be=t("hr",null,null,-1),Pe={class:"fw-bold text-primary"},Se={key:0,class:"mt-5 alert alert-warning alert-dismissible fade show",role:"alert"},xe=t("i",{class:"bi bi-exclamation-triangle me-1"},null,-1),Be={class:"mt-3 alert border-primary fade show",role:"alert"},Ie={class:"mb-0"},$e={class:"fw-bold text-primary"},Ee={key:0,class:"mt-4 alert alert-warning alert-dismissible fade show",role:"alert"},Ne=t("i",{class:"bi bi-exclamation-triangle me-1"},null,-1),ke={key:1},we=t("p",null,"Введите план для торговых представителей, участвующих в акции.",-1),Te={class:"list-group"},Ae=z('<li class="list-group-item m-0 px-2"><div class="row g-2 text-center align-items-center p-0"><div class="col-md-5 col-sm-12">ФИО</div><div class="col-md-2 col-sm-6">Продажи, факт</div><div class="col-md-2 col-sm-6">План, %</div><div class="col-md-2 col-sm-6">Продажи, план</div><div class="col-md-1 col-sm-6">Del</div></div></li>',1),Ce={class:"list-group-item m-0 px-2 bg-warning-light"},Oe={class:"row g-2 text-center align-items-center p-0"},Fe=t("div",{class:"col-md-5 col-sm-12"},[t("span",{class:"fw-bold"},"ИТОГО")],-1),Re={class:"col-md-2 col-sm-6"},Ve={class:"col-md-2 col-sm-6"},je={class:"col-md-2 col-sm-6"},Le=t("div",{class:"col-md-1 col-sm-6"},null,-1),Me={__name:"SalesPeopleBoost",props:{title:{type:String,required:!0,default:"Title is required"},customerId:{type:[Number,String],required:!0},customerName:{type:String,default:""}},emits:["addSellersToPromo"],setup(v,{emit:E}){const{get:i}=G();W();const b=()=>({sellerId:"",salesBefore:0,salesPlan:0,surplusPlan:0,budgetPlan:0,budgetActual:0}),_=v,N=E,d=L({sellers:[],checkedSellers:[],form:b()});H(()=>_.customerId,async e=>{d.sellers=[],d.checkedSellers=[],e!==""&&await g(e)});const g=async e=>{const{status:r,data:n}=await i(`${M.CUSTOMER}/${e}`,{params:{customer_sellers:!0}});r==="success"&&(d.sellers=n.sellers)},k=P(()=>d.sellers.filter(e=>e.isActive).filter(e=>e.isSupervisor).map(e=>({...e,...d.form,compensation:O}))),o=P(()=>d.sellers.filter(e=>e.isActive).filter(e=>!e.isSupervisor).map(e=>({...e,...d.form,compensation:C}))),s=e=>{const r=d.checkedSellers.findIndex(n=>n.id===e.id);r===-1?d.checkedSellers.push(e):d.checkedSellers[r]={...e},N("addSellersToPromo",d.checkedSellers,l.value,u.value,a.value)},l=P(()=>d.checkedSellers.reduce((e,r)=>((r.isSupervisor||r.supervisorId===null)&&(e+=parseInt(r.salesBefore)),e),0)),u=P(()=>d.checkedSellers.reduce((e,r)=>((r.isSupervisor||r.supervisorId===null)&&(e+=r.salesPlan),e),0)),a=P(()=>d.checkedSellers.reduce((e,r)=>e+parseInt(r.budgetPlan),0));return(e,r)=>{const n=Q("RouterLink");return m(),p("div",null,[t("div",_e,[t("div",pe,I(_.title),1),t("div",fe,[t("div",he,[ge,t("h4",ye,I(isNaN(a.value)?"0":B($)(a.value))+" руб.",1)]),be,t("h5",null,[x("Мотивация для расчёта бюджета: "),t("span",Pe," СВ: "+I(B(O))+" % ТП: "+I(B(C))+" %",1)]),_.customerId?(m(),p(S,{key:1},[t("div",Be,[t("h5",Ie,[x("Дистрибутор: "),t("span",$e,I(_.customerName),1)])]),d.sellers.length===0?(m(),p("div",Ee,[Ne,x(" В команду дистрибьютора не добавлено ни одного торгового представителя. "),f(n,{to:{name:"Manager.Customer.View",params:{id:_.customerId}},class:"fw-bold"},{default:j(()=>[x("Перейдите в карточку контрагента")]),_:1},8,["to"]),x(' на вкладку "Команда ТП" и добавьте торговых представителей. ')])):(m(),p("div",ke,[we,t("ul",Te,[Ae,(m(!0),p(S,null,F(k.value,(c,h)=>(m(),R(ve,{key:c.id,index:h,sellers:o.value,supervisor:c,onAddToCheckedSellers:s},null,8,["index","sellers","supervisor"]))),128)),(m(!0),p(S,null,F(o.value,(c,h)=>(m(),p(S,{key:c.id},[c.supervisorId===null?(m(),R(q,{key:0,seller:c,index:h,onAddSeller:s},null,8,["seller","index"])):U("",!0)],64))),128)),t("li",Ce,[t("div",Oe,[Fe,t("div",Re,[f(y,{value:isNaN(l.value)?"":B($)(l.value),class:"fw-bold border-secondary text-end",type:"text",readonly:""},null,8,["value"])]),t("div",Ve,[f(y,{disabled:"disabled"})]),t("div",je,[f(y,{value:B(A)(u.value),class:"fw-bold border-secondary text-end",type:"text",readonly:""},null,8,["value"])]),Le])])])]))],64)):(m(),p("div",Se,[xe,x(" Выберите дистрибутора в общих настройках промо-акции для подгрузки его торгового персонала. ")]))])])])}}};export{Me as default};
