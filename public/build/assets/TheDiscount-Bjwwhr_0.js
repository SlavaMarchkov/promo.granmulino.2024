import{o as u,c as m,h as $,f as s,t as c,i as h,g as a,w as l,j as r,T as B,F as k,r as O,y as C,e as Y,Y as K,d as F,G as V,m as z,p as i,s as S,H as T,q as f}from"./app-CvDqXEOd.js";import{u as J}from"./useHttpService-Cv4QBHm9.js";import{f as b}from"./formatters-CphxWokN.js";import{_ as Q}from"./Modal-BjKEkhVV.js";const W={class:"card mb-0"},X={class:"card-header bg-secondary-subtle py-2 fw-bold text-black"},Z={class:"card-header py-2 fw-bold text-primary"},ee={class:"card-body mt-2 pb-2"},se={class:"row"},oe=s("div",{class:"col-7"},'Продажи "До"',-1),te={class:"col-5 fw-bold text-end"},de={class:"row"},ae=s("div",{class:"col-6"},"План",-1),le={class:"col-6 fw-bold text-end"},re={class:"row"},ne=s("div",{class:"col-7"},"Прирост",-1),ce={class:"col-5 fw-bold text-end"},ie={class:"row"},ue=s("div",{class:"col-6"},"Бюджет",-1),me={class:"col-6 fw-bold text-end"},pe={class:"card-footer py-2"},_e={__name:"DiscountProductCard",props:{products:{type:Array,required:!0,default:[]}},emits:["removeProduct"],setup(y,{emit:w}){const x=y,I=w,g=v=>{I("removeProduct",v)};return(v,e)=>(u(!0),m(k,null,$(x.products,(n,p)=>(u(),m("div",{class:"col",key:p},[s("div",W,[s("h6",X,c(n.categoryName),1),s("h6",Z,c(n.productName),1),s("div",ee,[s("div",se,[oe,s("div",te,c(h(b)(n.salesBefore))+" шт.",1)]),s("div",de,[ae,s("div",le,c(h(b)(n.salesPlan))+" шт.",1)]),s("div",re,[ne,s("div",ce,c(h(b)(n.surplusPlan))+" %",1)]),s("div",ie,[ue,s("div",me,c(h(b)(n.budgetPlan))+" руб.",1)])]),s("div",pe,[a(B,{class:"btn-danger w-100",onClick:_=>g(p)},{default:l(()=>[r("Удалить")]),_:2},1032,["onClick"])])])]))),128))}},fe={class:"card"},ve={class:"card-header bg-success text-white"},he={class:"card-body mt-3"},be={class:"d-flex justify-content-between align-items-center"},ge=s("span",null,"Ассортимент для промо-акции",-1),Pe=s("hr",null,null,-1),ye={class:"mb-3"},we={class:"fw-bold text-primary"},xe={key:0,class:"row row-cols-xl-3 row-cols-lg-3 row-cols-md-2 row-cols-sm-2 row-cols-1 g-3"},Ie={class:"row g-3"},Ve={class:"col-md-6"},$e=s("option",{disabled:"",selected:"",value:""},"-- Выберите группу товара --",-1),Be=["value"],ke={class:"col-md-6"},Ue=s("option",{disabled:"",selected:"",value:""},"-- Выберите SKU для промо-акции --",-1),qe=["value"],Ne={class:"col-md-4"},Ce={class:"input-group"},Fe=s("span",{class:"input-group-text"},"шт.",-1),Se=s("div",{id:"sales_before_help",class:"form-text"},"если продаж не было, укажите 0",-1),Te={class:"col-md-4"},Ee={class:"input-group"},Me=s("span",{class:"input-group-text"},"шт.",-1),De={class:"col-md-4"},Le={class:"input-group"},Ae=s("span",{class:"input-group-text"},"%",-1),Re=s("div",{id:"surplus_plan_help",class:"form-text"},"рассчитывается автоматически",-1),je={class:"col-md-4"},Ge={class:"input-group"},He=s("span",{class:"input-group-text"},"руб.",-1),Oe=s("div",{id:"profit_plan_help",class:"form-text"},"берётся из P&L",-1),Ye={class:"col-md-4"},Ke={class:"input-group"},ze=s("span",{class:"input-group-text"},"руб.",-1),Je={class:"col-md-4"},Qe={class:"input-group"},We=s("span",{class:"input-group-text"},"руб.",-1),os={__name:"TheDiscount",props:{title:{type:String,required:!0,default:"Title is required"}},emits:["addProductToPromo","removeProductFromPromo"],setup(y,{emit:w}){const{get:x}=J(),I=y,g=w,v=()=>({categoryId:"",productId:"",salesBefore:0,salesPlan:0,surplusPlan:0,profitPlan:0,compensation:0,budgetPlan:0}),e=O({categories:[],products:[],form:v()}),n=C([]),p=C([]);let _=null;function P(){e.products=[],e.form=v()}Y(async()=>{await E(),_=new bootstrap.Modal(document.getElementById("modalPopUp")),_._element.addEventListener("hide.bs.modal",P)});const E=async()=>{const{data:d}=await x(K.CATEGORY,{params:{category_is_active:!0,product_is_active:!0,products:!0}});e.categories=d.categories},M=()=>{P(),_.show()},U=()=>{P(),_.hide(),_._element.removeEventListener("hide.bs.modal",P)},D=()=>{e.categories.map(d=>{+d.id==+e.form.categoryId&&(e.products=d.products)}),e.products=e.products.filter(d=>!p.value.includes(d.id))},L=()=>{n.value.push({categoryId:e.form.categoryId,productId:e.form.productId,categoryName:R(),productName:j(),salesBefore:e.form.salesBefore,salesPlan:e.form.salesPlan,surplusPlan:e.form.surplusPlan,budgetPlan:e.form.budgetPlan}),p.value.push(+e.form.productId),g("addProductToPromo",e.form),U()},A=d=>{n.value.splice(d,1),p.value.splice(d,1),g("removeProductFromPromo",d)},R=()=>{const d=e.categories.findIndex(o=>o.id===+e.form.categoryId);return e.categories[d].name},j=()=>{const d=e.categories.findIndex(t=>t.id===+e.form.categoryId),o=e.categories[d].products.findIndex(t=>t.id===+e.form.productId);return e.categories[d].products[o].name},G=F(()=>{let d=!0;for(let[o,t]of Object.entries(e.form))if(!(o==="salesBefore"||o==="surplusPlan")&&!t){d=!1;break}return d}),H=F(()=>n.value.reduce((d,o)=>d+parseInt(o.budgetPlan),0));V(()=>e.form.salesBefore,()=>q()),V(()=>e.form.salesPlan,()=>{q(),N()}),V(()=>e.form.compensation,()=>{N()});function q(){const d=+e.form.salesBefore,o=+e.form.salesPlan;e.form.surplusPlan=d===0?0:((o-d)/d*100).toFixed()}function N(){const d=+e.form.salesPlan,o=+e.form.compensation;e.form.budgetPlan=parseInt((o*d).toFixed(0))}return(d,o)=>(u(),m("div",null,[s("div",fe,[s("div",ve,c(I.title),1),s("div",he,[s("div",be,[ge,a(B,{onClick:M,class:"btn-success"},{default:l(()=>[r("Добавить")]),_:1})]),Pe,s("h5",ye,[r("Итоговый бюджет на промо-акцию: "),s("span",we,c(h(b)(H.value))+" руб.",1)]),n.value.length>0?(u(),m("div",xe,[a(_e,{products:n.value,onRemoveProduct:A},null,8,["products"])])):z("",!0)])]),a(Q,{id:"modalPopUp","close-func":U,"custom-classes":["modal-lg"]},{title:l(()=>[r(" Добавление ассортимента для промо-акции ")]),body:l(()=>[s("div",Ie,[s("div",Ve,[a(i,{for:"category_id",required:""},{default:l(()=>[r("Группа товара")]),_:1}),S(s("select",{"onUpdate:modelValue":o[0]||(o[0]=t=>e.form.categoryId=t),onChange:D,id:"category_id",class:"form-select"},[$e,(u(!0),m(k,null,$(e.categories,t=>(u(),m("option",{key:t.id,value:t.id},c(t.name),9,Be))),128))],544),[[T,e.form.categoryId]])]),s("div",ke,[a(i,{for:"product_id",required:""},{default:l(()=>[r("Ассортимент")]),_:1}),S(s("select",{"onUpdate:modelValue":o[1]||(o[1]=t=>e.form.productId=t),id:"product_id",class:"form-select"},[Ue,(u(!0),m(k,null,$(e.products,t=>(u(),m("option",{key:t.id,value:t.id},c(t.name),9,qe))),128))],512),[[T,e.form.productId]])]),s("div",Ne,[a(i,{for:"sales_before",required:""},{default:l(()=>[r('Продажи "До акции"')]),_:1}),s("div",Ce,[a(f,{id:"sales_before",modelValue:e.form.salesBefore,"onUpdate:modelValue":o[2]||(o[2]=t=>e.form.salesBefore=t),type:"number",min:"0","aria-describedby":"sales_before_help"},null,8,["modelValue"]),Fe]),Se]),s("div",Te,[a(i,{for:"sales_plan",required:""},{default:l(()=>[r('План продаж "Во время"')]),_:1}),s("div",Ee,[a(f,{id:"sales_plan",modelValue:e.form.salesPlan,"onUpdate:modelValue":o[3]||(o[3]=t=>e.form.salesPlan=t),type:"number",min:"0"},null,8,["modelValue"]),Me])]),s("div",De,[a(i,{for:"surplus_plan",required:""},{default:l(()=>[r("План прироста")]),_:1}),s("div",Le,[a(f,{id:"surplus_plan",modelValue:e.form.surplusPlan,"onUpdate:modelValue":o[4]||(o[4]=t=>e.form.surplusPlan=t),type:"number",disabled:"disabled","aria-describedby":"surplus_plan_help"},null,8,["modelValue"]),Ae]),Re]),s("div",je,[a(i,{for:"profit_plan",required:""},{default:l(()=>[r("Прибыль на 1 шт.")]),_:1}),s("div",Ge,[a(f,{id:"profit_plan",modelValue:e.form.profitPlan,"onUpdate:modelValue":o[5]||(o[5]=t=>e.form.profitPlan=t),type:"number",min:"0",step:"0.01","aria-describedby":"profit_plan_help"},null,8,["modelValue"]),He]),Oe]),s("div",Ye,[a(i,{for:"compensation",required:""},{default:l(()=>[r("Компенсация на 1 шт.")]),_:1}),s("div",Ke,[a(f,{id:"compensation",modelValue:e.form.compensation,"onUpdate:modelValue":o[6]||(o[6]=t=>e.form.compensation=t),type:"number",min:"0",step:"0.01","aria-describedby":"compensation_help"},null,8,["modelValue"]),ze])]),s("div",Je,[a(i,{for:"budget_plan",required:""},{default:l(()=>[r("Бюджет")]),_:1}),s("div",Qe,[a(f,{id:"budget_plan",modelValue:e.form.budgetPlan,"onUpdate:modelValue":o[7]||(o[7]=t=>e.form.budgetPlan=t),type:"number",disabled:"disabled","aria-describedby":"budget_plan_help"},null,8,["modelValue"]),We])])])]),footer:l(()=>[a(B,{onClick:L,class:"btn-success w-25",disabled:!G.value},{default:l(()=>[r("Добавить")]),_:1},8,["disabled"])]),_:1})]))}};export{os as default};
